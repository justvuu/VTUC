<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sửa danh mục</title>
    <link rel="stylesheet" href="../assets//css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>

<style>
    .transaction {
        background-color: #F8F8F8;
        padding: 15px;
        border-radius: 16px;
    }

    .form-check-input[type="radio"] {
        width: 20px;
        height: 20px;
    }

    .form-check-label {
        display: flex;
        margin-left: 5px;
        margin-top: 2px;
        align-items: center;
    }

    .icon-select {
        padding: 5px 20px;
        border-radius: 8px;
        background: transparent;
        border: 0.2px solid lightgray;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .icon-select img {
        width: 28px;
        height: 28px;
    }

    .selected-icon {
        border: 1.5px solid #000000;
    }

    .color-select {
        border: 0.2px solid lightgray;
        padding: 20px 36px;
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .selected-color {
        border: 1.5px solid #000000;
    }

    .btn-edit {
        width: 100%;
        height: 49px;
        background-color: #29756F;
        color: #FFFFFF;
        border: 2px solid transparent;
        border-radius: 5px;
        margin-top: 32px;
    }

    .inactive-btn {
        opacity: 0.5;
        pointer-events: none;
    }
</style>

<body>
    <div class="container">
        <div class="title d-flex justify-content-between mt-5 mb-3">
            <a class="text-dark text-decoration-none back"> Hủy </a>
            <h5>Sửa danh mục</h5>
            <span></span>
        </div>

        <form>
            <div class="mb-3">
                <label class="form-label fw-bold">Loại danh mục:</label>
                <div class="d-flex gap-5">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="categoryType" id="expenseRadio"
                            value="expense">
                        <label class="form-check-label" for="expenseRadio">Chi tiêu</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="categoryType" id="incomeRadio"
                            value="income">
                        <label class="form-check-label" for="incomeRadio">Thu nhập</label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Tên danh mục:</label>
                <input type="text" class="form-control" id="name">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Mô tả:</label>
                <input type="text" class="form-control" id="description">

            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Biểu tượng:</label>
                <div class="icon">
                    <div class="row">
                        <div class="col-md-12 d-flex justify-content-around">
                            <div class="icon-select" data-icon="restaurant">
                                <img src="../assets/images/restaurant.svg" alt="restaurant">
                            </div>

                            <div class="icon-select" data-icon="shopping_bag">
                                <img src="../assets/images/shopping_bag.svg" alt="shopping_bag">
                            </div>

                            <div class="icon-select" data-icon="car">
                                <img src="../assets/images/car.svg" alt="car">
                            </div>

                            <div class="icon-select" data-icon="recurring_bill">
                                <img src="../assets/images/recurring_bill.svg" alt="recurring_bill">
                            </div>
                        </div>
                        <div class="col-md-12 d-flex justify-content-around mt-3">
                            <div class="icon-select" data-icon="salary">
                                <img src="../assets/images/salary.svg" alt="salary">
                            </div>

                            <div class="icon-select" data-icon="backpack">
                                <img src="../assets/images/backpack.svg" alt="backpack">
                            </div>

                            <div class="icon-select" data-icon="medicine">
                                <img src="../assets/images/medicine.svg" alt="medicine">
                            </div>

                            <div class="icon-select" data-icon="music">
                                <img src="../assets/images/music.svg" alt="music">
                            </div>
                        </div>
                        <div class="col-md-12 d-flex justify-content-around mt-3">
                            <div class="icon-select" data-icon="house">
                                <img src="../assets/images/house.svg" alt="house">
                            </div>

                            <div class="icon-select" data-icon="internet">
                                <img src="../assets/images/internet.svg" alt="internet">
                            </div>

                            <div class="icon-select" data-icon="game">
                                <img src="../assets/images/game.svg" alt="game">
                            </div>

                            <div class="icon-select" data-icon="phone">
                                <img src="../assets/images/phone.svg" alt="phone">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Màu sắc:</label>
                <div class="icon">
                    <div class="row">
                        <div class="col-md-12 d-flex justify-content-around">
                            <div class="color-select" data-icon-color="#B08B46" data-bg-color="#ECD4A7"
                                style="background: #B08B46;">
                            </div>

                            <div class="color-select" data-icon-color="#FCAC12" data-bg-color="#FEEED0"
                                style="background: #FCAC12;">
                            </div>

                            <div class="color-select" data-icon-color="#A31D24" data-bg-color="#FFA9A9"
                                style="background: #A31D24;">
                            </div>

                            <div class="color-select" data-icon-color="#FD3C4A" data-bg-color="#FDD5D7"
                                style="background: #FD3C4A;">
                            </div>
                        </div>
                        <div class="col-md-12 d-flex justify-content-around mt-3">
                            <div class="color-select" data-icon-color="#9321C8" data-bg-color="#FFC1F9"
                                style="background: #9321C8;">
                            </div>

                            <div class="color-select" data-icon-color="#0077FF" data-bg-color="#BDDCFF"
                                style="background: #0077FF;">
                            </div>

                            <div class="color-select" data-icon-color="#00A86B" data-bg-color="#CFFAEA"
                                style="background: #00A86B;">
                            </div>

                            <div class="color-select" data-icon-color="#F088F9" data-bg-color="#FFDBFB"
                                style="background: #F088F9;">
                            </div>
                        </div>
                        <div class="col-md-12 d-flex justify-content-around mt-3">
                            <div class="color-select" data-icon-color="#F18E33" data-bg-color="#FFD7B2"
                                style="background: #F18E33;">
                            </div>

                            <div class="color-select" data-icon-color="#7F3DFF" data-bg-color="#EEE5FF"
                                style="background: #7F3DFF;">
                            </div>

                            <div class="color-select" data-icon-color="#55F7E3" data-bg-color="#D2F4F2"
                                style="background: #55F7E3;">
                            </div>

                            <div class="color-select" data-icon-color="#F9F135" data-bg-color="#FFF6C6"
                                style="background: #F9F135;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-edit inactive-btn">Lưu</button>
        </form>


        <div class="toast-container position-fixed top-0 end-0"
            style="z-index: 11; width: 60%;  margin-top: 15%; margin-right: 5px;">
            <div id="errToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
                style="border-radius: 8px;">
                <div class="toast-body" style="border-radius: 8px; background-color: rgba(225, 30, 16, 0.5);">
                    <strong class="me-auto" style="color: #e8320d;">Tên danh mục đã tồn tại</strong>
                </div>
            </div>
        </div>

        <div style="margin-top: 100px;" id="navbar"></div>
</body>

<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.2/js/bootstrap.min.js"></script>

<script>
    fetch('../components/navbar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('navbar').innerHTML = data;
            const user_nav = document.getElementById("user-nav");
            user_nav.setAttribute("src", "../assets/images/user_active.svg");
        });


    // lấy ds danh mục trong local storage
    function getCategories() {
        const categoriesJSON = localStorage.getItem('categories');
        if (categoriesJSON) {
            return JSON.parse(categoriesJSON);
        } else {
            return [];
        }
    }

    // Lấy tham số truy vấn categoryIndex từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const categoryId = urlParams.get('categoryId');

    const detailCategoryURL = `/page/detail_category.html?categoryId=${categoryId}`;
    document.querySelector('.back').href = detailCategoryURL;

    // Lấy danh sách danh mục từ localStorage
    const categories = getCategories();

    let selectedCategory = null;
    categories.forEach((category) => {
        if (category.id == categoryId) {
            selectedCategory = category;
        }
    })



</script>

<script>
    // -------------- các sự kiện diễn ra của các trường nhập dữ liệu thêm mới 
    const expenseRadio = document.getElementById('expenseRadio');
    const incomeRadio = document.getElementById('incomeRadio');
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const iconButtons = document.querySelectorAll('.icon-select');
    const colorButtons = document.querySelectorAll('.color-select');
    const editButton = document.querySelector('.btn-edit');

    if (selectedCategory.categoryType == "expense") {
        expenseRadio.checked = true;
    } else {
        incomeRadio.checked = true;
    }

    nameInput.value = selectedCategory.name;

    if (selectedCategory.description != null) {
        descriptionInput.value = selectedCategory.description
    } else {
        descriptionInput.placeholder = "Chưa có mô tả";
    }

    let btnIconDefault = null;
    iconButtons.forEach((button) => {
        const icon = button.getAttribute("data-icon");

        if (icon == selectedCategory.icon) {
            button.classList.add('selected-icon');
            btnIconDefault = button;
        }
    });

    let btnColorDefault = null;
    colorButtons.forEach((button) => {
        const iconColor = button.getAttribute("data-icon-color");
        const iconBgColor = button.getAttribute("data-bg-color");

        if (iconColor == selectedCategory.iconColor && iconBgColor == selectedCategory.iconBgColor) {
            button.classList.add('selected-color');
            btnColorDefault = button;
        }
    });


    // ktra xem có đủ điều kiện để kích hoạt nút Lưu ko
    function checkFields() {
        let check = false;
        let isValue = false;
        if (nameInput.value.trim() != '' && selectedIconButton != null && selectedCategoryType != null) {
            isValue = true;
        }

        if (nameInput.value.trim() != selectedCategory.name && nameInput.value.trim() != '' && isValue == true) {
            check = true;
        }

        if (selectedCategory.categoryType == "expense" && incomeRadio.checked == true && isValue == true) {
            chech = true;
        }

        if (selectedCategory.categoryType == "income" && expenseRadio.checked == true && isValue == true) {
            check = true;
        }

        if (descriptionInput.value.trim() != selectedCategory.description && isValue == true) {
            check = true;
        }

        if (btnIconDefault != selectedIconButton && selectedIconButton != null && isValue == true) {
            check = true;
        }

        if (btnColorDefault != selectedColorButton && isValue == true) {
            check = true;
        }

        if (check) {
            editButton.classList.remove('inactive-btn');
        } else {
            editButton.classList.add('inactive-btn');
        }
    };

    let selectedCategoryType = 'expense'; // Mặc định là 'Chi tiêu'
    // Bắt sự kiện khi radio button được chọn
    expenseRadio.addEventListener('change', () => {
        if (expenseRadio.checked) {
            selectedCategoryType = 'expense';
        }
        checkFields();
    });

    incomeRadio.addEventListener('change', () => {
        if (incomeRadio.checked) {
            selectedCategoryType = 'income';
        }
        checkFields();
    });


    // Bắt sự kiện khi trường tên danh mục thay đổi
    nameInput.addEventListener('input', () => {
        checkFields();
    });

    // ----------bắt sự kiện khi nút icon được chọn 
    let selectedIconButton = btnIconDefault; // Biến lưu trạng thái nút icon được chọn
    iconButtons.forEach((button) => {
        button.addEventListener('click', () => {
            if (selectedIconButton === button) {
                // Nếu ấn vào icon đang được focus, hủy focus
                selectedIconButton.classList.remove('selected-icon');
                selectedIconButton = null;

            } else {
                // Nếu ấn vào icon khác, hủy focus icon cũ và focus icon mới
                if (selectedIconButton) {
                    selectedIconButton.classList.remove('selected-icon');
                }
                selectedIconButton = button;
                selectedIconButton.classList.add('selected-icon');

            }
            checkFields();
        });
    });

    // ----------bắt sự kiện khi nút màu được chọn
    let selectedColorButton = btnColorDefault;

    colorButtons.forEach((button) => {
        button.addEventListener('click', () => {
            if (selectedColorButton === button) {
                // Nếu ấn vào màu đang được focus, hủy focus
                selectedColorButton.classList.remove('selected-color');
                selectedColorButton = null;

            } else {
                // Nếu ấn vào icon khác, hủy focus icon cũ và focus icon mới
                if (selectedColorButton) {
                    selectedColorButton.classList.remove('selected-color');
                }
                selectedColorButton = button;
                selectedColorButton.classList.add('selected-color');
            }
            checkFields();
        });
    });

    // lấy ds danh mục trong local storage
    function getCategories() {
        const categoriesJSON = localStorage.getItem('categories');
        if (categoriesJSON) {
            return JSON.parse(categoriesJSON);
        } else {
            return [];
        }
    }

    // lưu ds danh mục vào Local Storage
    function saveCategories(categories) {
        localStorage.setItem('categories', JSON.stringify(categories));
    }

    function checkNameDuplicate(){
        const categories = getCategories();
        const name = document.getElementById('name').value.trim();
        const isNameDuplicate = categories.some(category => category.name.toLowerCase() === name.toLowerCase());
        if (isNameDuplicate) {
            return false;
        } else {
            return true;
        }
    }

    // ----------- sửa 1 danh mục và lưu vào local storage
    editButton.addEventListener('click', function () {
        event.preventDefault();
        const name = document.getElementById('name').value.trim();
        const description = document.getElementById('description').value || null;
        const icon = selectedIconButton.dataset.icon;

        if(checkNameDuplicate() == false){
             // Hiển thị thông báo lỗi nếu tên danh mục bị trùng
             var myToast = new bootstrap.Toast(document.getElementById('errToast'));
            myToast.show();

            setTimeout(function () {
                myToast.hide();
            }, 2000);
        } else {
            let iconColor = '#000000';
            let iconBgColor = '#C4C4C4';
            if (selectedColorButton) {
                iconColor = selectedColorButton.dataset.iconColor;
                iconBgColor = selectedColorButton.dataset.bgColor;
            }

            selectedCategory.categoryType = selectedCategoryType;
            selectedCategory.name = name;
            selectedCategory.description = description;
            selectedCategory.icon = icon;
            selectedCategory.iconColor = iconColor;
            selectedCategory.iconBgColor = iconBgColor;
            saveCategories(categories);
            window.location.href = "/page/categories.html?isSuccess=true";
        }
    });
</script>

</html>